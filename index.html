<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realms of Chance - Glyphdex</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f5f0;
            color: #3d3d3d;
            background-image: url("https://images.unsplash.com/photo-1544273677-c433136021d4?q=80&w=2070");
            background-size: cover;
            background-attachment: fixed;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Merriweather', serif;
        }
        .keyword {
            font-weight: 600;
            font-style: italic;
            color: #8c7a6b;
        }
        .keyword-value {
            font-weight: 700;
            color: #5c4d41;
        }
        .glyph-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .glyph-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .edit-controls { display: none; }
        body.edit-mode .edit-controls { display: flex; }
        #modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8 p-6 bg-white/80 backdrop-blur-sm rounded-lg shadow-lg">
            <div class="flex justify-center items-center gap-4 mb-4">
                 <label for="edit-mode-toggle" class="flex items-center cursor-pointer">
                    <span class="mr-3 text-gray-700 font-semibold">Admin Mode</span>
                    <div class="relative">
                      <input type="checkbox" id="edit-mode-toggle" class="sr-only">
                      <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                      <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                    </div>
                </label>
                <button id="download-json-btn" class="edit-controls px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition">Download glyphs.json</button>
            </div>
            <h1 class="text-5xl font-bold text-gray-900">The Art of Glyph-Weaving</h1>
            <p class="text-xl text-gray-600 mt-2">A Compendium for the Realms of Chance</p>
        </header>

        <main id="app" class="space-y-12">
            <div id="loading" class="text-center text-white text-2xl font-semibold">Loading Glyph Library...</div>
        </main>

        <footer class="text-center mt-12 text-white/70">
            <p>Realms of Chance TTRPG System. All rights reserved.</p>
        </footer>
    </div>

    <!-- Modal for Editing/Adding Glyphs -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 opacity-0 z-50">
        <div id="modal" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg transform scale-95 transition-transform">
            <h3 id="modal-title" class="text-2xl font-bold mb-4">Edit Glyph</h3>
            <form id="glyph-form" class="space-y-4">
                <input type="hidden" id="glyph-id">
                <input type="hidden" id="tome-id">
                <div>
                    <label for="glyph-name" class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="glyph-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="glyph-tier" class="block text-sm font-medium text-gray-700">Tier</label>
                        <input type="number" id="glyph-tier" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label for="glyph-type" class="block text-sm font-medium text-gray-700">Type</label>
                        <select id="glyph-type" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            <option>Foundation</option>
                            <option>Modifier</option>
                            <option>Rote</option>
                            <option>Reactive</option>
                        </select>
                    </div>
                </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="glyph-diceCost" class="block text-sm font-medium text-gray-700">Dice Cost (e.g., +1 Dice)</label>
                        <input type="text" id="glyph-diceCost" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label for="glyph-lockCost" class="block text-sm font-medium text-gray-700">Lock Cost (e.g., 1 Lock)</label>
                        <input type="text" id="glyph-lockCost" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                </div>
                <div>
                    <label for="glyph-description" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="glyph-description" rows="4" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const app = document.getElementById('app');
            const loadingEl = document.getElementById('loading');
            let glyphData = null;
            let isEditMode = false;
            let currentEditingGlyph = null;

            const fetchGlyphs = async () => {
                try {
                    const response = await fetch('glyphs.json');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    glyphData = await response.json();
                    loadingEl.style.display = 'none';
                    renderApp();
                } catch (error) {
                    loadingEl.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert">
                                             <strong class="font-bold">Error!</strong>
                                             <span class="block sm:inline">Could not load glyphs.json.</span>
                                           </div>`;
                    console.error("Error fetching glyphs:", error);
                }
            };
            
            const renderApp = () => {
                app.innerHTML = '';
                if(glyphData && glyphData.tomes) {
                    glyphData.tomes.forEach(tome => renderTome(tome));
                }
            };

            const renderTome = (tome) => {
                const tomeSection = document.createElement('section');
                tomeSection.id = tome.id;
                tomeSection.className = 'p-6 bg-white/80 backdrop-blur-sm rounded-lg shadow-lg';

                let coreFoundationsHTML = tome.coreFoundations.map(glyph => renderGlyph(glyph, 'Core', tome.id)).join('');
                let purchasableGlyphsHTML = tome.purchasableGlyphs.map(glyph => renderGlyph(glyph, 'Purchasable', tome.id)).join('');

                tomeSection.innerHTML = `
                    <div class="border-b-2 border-gray-300 pb-4 mb-6">
                        <div class="flex justify-between items-start">
                            <h2 class="text-4xl font-bold text-gray-800">${tome.name}</h2>
                            <button class="add-glyph-btn edit-controls px-3 py-1 bg-green-500 text-white rounded-md text-sm" data-tome-id="${tome.id}">+ Add Glyph</button>
                        </div>
                        <p class="text-lg text-gray-600 mt-2 italic">${tome.philosophy}</p>
                        <div class="mt-4 p-4 bg-amber-50 border-l-4 border-amber-400 rounded-r-lg">
                            <h4 class="font-bold text-amber-800">Core Mechanic: ${tome.coreMechanic.name}</h4>
                            <p class="text-amber-700">${tome.coreMechanic.description}</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-gray-700 mb-4">Core Foundation Set</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${coreFoundationsHTML}
                        </div>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-2xl font-bold text-gray-700 mb-4">Purchasable Glyphs</h3>
                         <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${purchasableGlyphsHTML}
                        </div>
                    </div>
                `;
                app.appendChild(tomeSection);
            };

            const renderGlyph = (glyph, type, tomeId) => {
                const description = glyph.description.replace(/`\[([^:]+):([^\]]+)\]`/g, 
                    '<span class="keyword">$1:</span> <span class="keyword-value">$2</span>'
                );
                
                let costHTML = '';
                if (glyph.diceCost) costHTML = `<p class="text-sm font-semibold text-blue-600">Dice Cost: ${glyph.diceCost}</p>`;
                if (glyph.lockCost) costHTML = `<p class="text-sm font-semibold text-purple-600">Lock Cost: ${glyph.lockCost}</p>`;

                const glyphId = `${tomeId}-${glyph.name.replace(/\s+/g, '-')}`;

                return `
                    <div class="glyph-card bg-white rounded-lg shadow-md p-4 flex flex-col h-full border-t-4 ${getTierColor(glyph.tier)}">
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <h4 class="text-xl font-bold text-gray-800">${glyph.name}</h4>
                                <span class="text-xs font-bold px-2 py-1 rounded-full ${type === 'Core' ? 'bg-green-100 text-green-800' : 'bg-gray-200 text-gray-800'}">${type === 'Core' ? 'Core' : `Tier ${glyph.tier}`}</span>
                            </div>
                            <p class="text-sm font-semibold text-gray-500 mb-2">${glyph.type}</p>
                            <p class="text-gray-700 text-sm">${description}</p>
                        </div>
                        <div class="mt-4 pt-2 border-t border-gray-200 flex justify-between items-center">
                            <div>${costHTML}</div>
                             <div class="edit-controls space-x-2">
                                <button class="edit-glyph-btn text-blue-500 hover:text-blue-700" data-glyph-name="${glyph.name}" data-tome-id="${tomeId}" data-type="${type.toLowerCase()}">Edit</button>
                                <button class="delete-glyph-btn text-red-500 hover:text-red-700" data-glyph-name="${glyph.name}" data-tome-id="${tomeId}" data-type="${type.toLowerCase()}">Del</button>
                            </div>
                        </div>
                    </div>
                `;
            };

            const getTierColor = (tier) => {
                const colors = { 0: 'border-green-400', 1: 'border-gray-400', 2: 'border-blue-400', 3: 'border-indigo-400', 4: 'border-purple-400', 5: 'border-red-400' };
                return colors[tier] || 'border-gray-400';
            };
            
            // MODAL and EDITING LOGIC
            const modalBackdrop = document.getElementById('modal-backdrop');
            const modal = document.getElementById('modal');
            const form = document.getElementById('glyph-form');

            const openModal = (glyph, tomeId, glyphType) => {
                currentEditingGlyph = { glyph, tomeId, glyphType };
                form.reset();
                if (glyph) { // Editing existing glyph
                    document.getElementById('modal-title').textContent = "Edit Glyph";
                    document.getElementById('glyph-name').value = glyph.name;
                    document.getElementById('glyph-tier').value = glyph.tier;
                    document.getElementById('glyph-tier').disabled = glyphType === 'core';
                    document.getElementById('glyph-type').value = glyph.type;
                    document.getElementById('glyph-diceCost').value = glyph.diceCost || '';
                    document.getElementById('glyph-lockCost').value = glyph.lockCost || '';
                    document.getElementById('glyph-description').value = glyph.description;
                } else { // Adding new glyph
                    document.getElementById('modal-title').textContent = "Add New Glyph";
                    document.getElementById('glyph-tier').disabled = false;
                    document.getElementById('tome-id').value = tomeId;
                }
                modalBackdrop.classList.remove('hidden');
                setTimeout(() => {
                    modalBackdrop.classList.remove('opacity-0');
                    modal.classList.remove('scale-95');
                }, 10);
            };

            const closeModal = () => {
                modalBackdrop.classList.add('opacity-0');
                modal.classList.add('scale-95');
                setTimeout(() => {
                    modalBackdrop.classList.add('hidden');
                }, 300);
            };

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const updatedGlyph = {
                    name: document.getElementById('glyph-name').value,
                    tier: parseInt(document.getElementById('glyph-tier').value),
                    type: document.getElementById('glyph-type').value,
                    diceCost: document.getElementById('glyph-diceCost').value || undefined,
                    lockCost: document.getElementById('glyph-lockCost').value || undefined,
                    description: document.getElementById('glyph-description').value,
                };

                if (currentEditingGlyph && currentEditingGlyph.glyph) { // Update
                    const { tomeId, glyphType } = currentEditingGlyph;
                    const tome = glyphData.tomes.find(t => t.id === tomeId);
                    const list = glyphType === 'core' ? tome.coreFoundations : tome.purchasableGlyphs;
                    const index = list.findIndex(g => g.name === currentEditingGlyph.glyph.name);
                    if (index > -1) list[index] = { ...list[index], ...updatedGlyph };
                } else { // Add
                    const tomeId = document.getElementById('tome-id').value;
                    const tome = glyphData.tomes.find(t => t.id === tomeId);
                    tome.purchasableGlyphs.push(updatedGlyph);
                }
                renderApp();
                closeModal();
            });

            document.getElementById('modal-cancel').addEventListener('click', closeModal);
            modalBackdrop.addEventListener('click', (e) => {
                if(e.target === modalBackdrop) closeModal();
            });
            
            // EVENT LISTENERS
            document.getElementById('edit-mode-toggle').addEventListener('change', (e) => {
                isEditMode = e.target.checked;
                document.body.classList.toggle('edit-mode', isEditMode);
            });

            document.getElementById('download-json-btn').addEventListener('click', () => {
                const dataStr = JSON.stringify(glyphData, null, 4);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = 'glyphs.json';
                
                let linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            });
            
            app.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-glyph-btn')) {
                    openModal(null, e.target.dataset.tomeId, 'purchasable');
                }
                if (e.target.classList.contains('edit-glyph-btn')) {
                    const { glyphName, tomeId, type } = e.target.dataset;
                    const tome = glyphData.tomes.find(t => t.id === tomeId);
                    const list = type === 'core' ? tome.coreFoundations : tome.purchasableGlyphs;
                    const glyph = list.find(g => g.name === glyphName);
                    openModal(glyph, tomeId, type);
                }
                if (e.target.classList.contains('delete-glyph-btn')) {
                   if (confirm('Are you sure you want to delete this glyph?')) {
                        const { glyphName, tomeId, type } = e.target.dataset;
                        const tome = glyphData.tomes.find(t => t.id === tomeId);
                        if (type === 'core') {
                            tome.coreFoundations = tome.coreFoundations.filter(g => g.name !== glyphName);
                        } else {
                            tome.purchasableGlyphs = tome.purchasableGlyphs.filter(g => g.name !== glyphName);
                        }
                        renderApp();
                   }
                }
            });

            fetchGlyphs();
        });
    </script>
</body>
</html>

